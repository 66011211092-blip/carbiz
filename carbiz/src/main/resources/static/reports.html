<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ | CarBiz</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
          font-family: "Segoe UI", sans-serif;
          background: #f8f9fa;
          margin: 0;
          padding: 0;
        }
        header {
          background: #0d6efd;
          color: white;
          padding: 15px;
          font-size: 22px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        header a {
          color: white;
          text-decoration: none;
          background: rgba(255,255,255,0.2);
          padding: 5px 12px;
          border-radius: 6px;
        }
        main { padding: 30px; }
        .card {
          background: white;
          padding: 15px;
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          margin-bottom: 20px;
        }
        .summary {
          display: flex;
          gap: 20px;
          flex-wrap: wrap;
        }
        .summary .card {
          flex: 1;
          min-width: 200px;
          text-align: center;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 15px;
          background: white;
          border-radius: 8px;
          overflow: hidden;
        }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #0d6efd; color: white; }
        footer { margin-top: 40px; color: #777; text-align: center; }
    </style>

    <script>
        const API_BASE = "http://localhost:8080";

        async function apiFetch(endpoint, options = {}) {
          const res = await fetch(`${API_BASE}${endpoint}`, {
            headers: { "Content-Type": "application/json" },
            ...options
          });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return await res.json();
        }

        async function loadOverview() {
          try {
            const data = await apiFetch("/api/reports/overview");
            document.getElementById("totalDeals").innerText = data.deals;
            document.getElementById("totalRevenue").innerText = data.revenue.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
            document.getElementById("totalProfit").innerText = data.profit.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
          } catch (err) {
            console.error("‡πÇ‡∏´‡∏•‡∏î overview ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
          }
        }

        async function loadMonthlyChart() {
          try {
            const data = await apiFetch("/api/reports/monthly");
            const labels = data.map(d => `${d.month}/${d.year}`);
            const revenue = data.map(d => d.revenue);
            const profit = data.map(d => d.profit);

            new Chart(document.getElementById("monthlyChart"), {
              type: "bar",
              data: {
                labels,
                datasets: [
                  { label: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ", data: revenue, backgroundColor: "#0d6efd" },
                  { label: "‡∏Å‡∏≥‡πÑ‡∏£", data: profit, backgroundColor: "#198754" }
                ]
              },
              options: {
                responsive: true,
                scales: {
                  y: { beginAtZero: true }
                }
              }
            });
          } catch (err) {
            console.error("‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
          }
        }

        async function loadTopCars() {
          const tbody = document.querySelector("#topCars tbody");
          try {
            const data = await apiFetch("/api/reports/top-cars");
            tbody.innerHTML = "";
            data.forEach((r, i) => {
              tbody.innerHTML += `
                <tr>
                  <td>${i + 1}</td>
                  <td>Car #${r.carId}</td>
                  <td>${r.deals}</td>
                  <td>${r.revenue} ‡∏ö‡∏≤‡∏ó</td>
                  <td>${r.profit} ‡∏ö‡∏≤‡∏ó</td>
                </tr>`;
            });
          } catch (err) {
            console.error("‡πÇ‡∏´‡∏•‡∏î TopCars ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
            tbody.innerHTML = "<tr><td colspan='5' style='color:red;'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>";
          }
        }

        async function loadTopCustomers() {
          const tbody = document.querySelector("#topCustomers tbody");
          try {
            const data = await apiFetch("/api/reports/top-customers");
            tbody.innerHTML = "";
            data.forEach((r, i) => {
              tbody.innerHTML += `
                <tr>
                  <td>${i + 1}</td>
                  <td>${r.customerName}</td>
                  <td>${r.deals}</td>
                  <td>${r.revenue} ‡∏ö‡∏≤‡∏ó</td>
                  <td>${r.profit} ‡∏ö‡∏≤‡∏ó</td>
                </tr>`;
            });
          } catch (err) {
            console.error("‡πÇ‡∏´‡∏•‡∏î TopCustomers ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", err);
            tbody.innerHTML = "<tr><td colspan='5' style='color:red;'>‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>";
          }
        }

        window.addEventListener("DOMContentLoaded", () => {
          loadOverview();
          loadMonthlyChart();
          loadTopCars();
          loadTopCustomers();
        });
    </script>
</head>

<body>
<header>
    <div>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
    <a href="index.html">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard</a>
</header>

<main>
    <section class="summary">
        <div class="card">
            <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏µ‡∏•</h3>
            <p id="totalDeals">-</p>
        </div>
        <div class="card">
            <h3>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</h3>
            <p id="totalRevenue">-</p>
        </div>
        <div class="card">
            <h3>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°</h3>
            <p id="totalProfit">-</p>
        </div>
    </section>

    <div class="card">
        <h3>üìà ‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
        <canvas id="monthlyChart" height="100"></canvas>
    </div>

    <div class="card">
        <h3>üöó ‡∏£‡∏ñ‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h3>
        <table id="topCars">
            <thead>
            <tr>
                <th>#</th>
                <th>‡∏£‡∏ñ</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏µ‡∏•</th>
                <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="card">
        <h3>üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏¢‡∏≠‡∏∞ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h3>
        <table id="topCustomers">
            <thead>
            <tr>
                <th>#</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏µ‡∏•</th>
                <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                <th>‡∏Å‡∏≥‡πÑ‡∏£</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<footer>¬© 2025 CarBiz Management System</footer>
</body>
</html>
